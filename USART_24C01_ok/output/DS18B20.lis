                        .module DS18B20.c
                        .area text(rom, con, rel)
 0000                   .dbfile ..\source\lib\DS18B20.c
                        .area data(ram, con, rel)
 0000                   .dbfile ..\source\lib\DS18B20.c
 0000           _current_temp_display_buffer::
 0000                   .blkb 15
                        .area idata
 0000 54656D703A20202020202020202000    .byte 'T,'e,'m,'p,58,32,32,32,32,32,32,32,32,32,0
                        .area data(ram, con, rel)
 000F                   .dbfile ..\source\lib\DS18B20.c
 000F                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 000F                   .dbsym e current_temp_display_buffer _current_temp_display_buffer A[15:15]c
 000F           _currentT::
 000F                   .blkb 1
                        .area idata
 000F 00                .byte 0
                        .area data(ram, con, rel)
 0010                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 0010                   .dbsym e currentT _currentT c
 0010           _df_table::
 0010                   .blkb 2
                        .area idata
 0010 0001              .byte 0,1
                        .area data(ram, con, rel)
 0012                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 0012                   .blkb 2
                        .area idata
 0012 0102              .byte 1,2
                        .area data(ram, con, rel)
 0014                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 0014                   .blkb 2
                        .area idata
 0014 0203              .byte 2,3
                        .area data(ram, con, rel)
 0016                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 0016                   .blkb 2
                        .area idata
 0016 0404              .byte 4,4
                        .area data(ram, con, rel)
 0018                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 0018                   .blkb 2
                        .area idata
 0018 0506              .byte 5,6
                        .area data(ram, con, rel)
 001A                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 001A                   .blkb 2
                        .area idata
 001A 0607              .byte 6,7
                        .area data(ram, con, rel)
 001C                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 001C                   .blkb 2
                        .area idata
 001C 0708              .byte 7,8
                        .area data(ram, con, rel)
 001E                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 001E                   .blkb 2
                        .area idata
 001E 0909              .byte 9,9
                        .area data(ram, con, rel)
 0020                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 0020                   .dbsym e df_table _df_table A[16:16]c
 0020           _ds18b20_error::
 0020                   .blkb 1
                        .area idata
 0020 00                .byte 0
                        .area data(ram, con, rel)
 0021                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 0021                   .dbsym e ds18b20_error _ds18b20_error c
 0021           _temp_value::
 0021                   .blkb 2
                        .area idata
 0021 0000              .byte 0,0
                        .area data(ram, con, rel)
 0023                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 0023                   .dbsym e temp_value _temp_value A[2:2]c
 0023           _display_digit::
 0023                   .blkb 2
                        .area idata
 0023 0000              .byte 0,0
                        .area data(ram, con, rel)
 0025                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 0025                   .blkb 2
                        .area idata
 0025 0000              .byte 0,0
                        .area data(ram, con, rel)
 0027                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 0027                   .dbsym e display_digit _display_digit A[4:4]c
                        .area text(rom, con, rel)
 0000                   .dbfile D:\desk_station\LM041L\AVR_licheng\USART_24C01_ok\source\lib\DS18B20.c
 0000                   .dbfunc e init_ds18b20 _init_ds18b20 fc
 0000           ;         status -> R20
                        .even
 0000           _init_ds18b20::
 0000 4A93              st -y,R20
 0002                   .dbline -1
 0002                   .dbline 15
 0002           ; #include "..\config.h"
 0002           ; 
 0002           ; char current_temp_display_buffer[]={"Temp:         "};
 0002           ; unsigned char currentT=0;
 0002           ; const unsigned char df_table[]={0,1,1,2,2,3,4,4,5,6,6,7,7,8,9,9};
 0002           ; unsigned char ds18b20_error=0;
 0002           ; unsigned char temp_value[]={0x00,0x00};
 0002           ; unsigned char display_digit[]={0,0,0,0};
 0002           ; 
 0002           ; 
 0002           ; 
 0002           ; 
 0002           ; //初始化DS18B20
 0002           ; unsigned char init_ds18b20(void)
 0002           ; {
 0002                   .dbline 17
 0002           ;  unsigned char status;
 0002           ;  DQ_DDR_1();
 0002 80916100          lds R24,97
 0006 8460              ori R24,4
 0008 80936100          sts 97,R24
 000C                   .dbline 18
 000C           ;  DQ_0();
 000C 80916200          lds R24,98
 0010 8B7F              andi R24,251
 0012 80936200          sts 98,R24
 0016                   .dbline 19
 0016           ;  delay_nus(540); //主机拉低总线，占总线
 0016 0CE1              ldi R16,540
 0018 12E0              ldi R17,2
 001A 0E940000          xcall _delay_nus
 001E                   .dbline 21
 001E           ;  
 001E           ;  DQ_DDR_0();
 001E 80916100          lds R24,97
 0022 8B7F              andi R24,251
 0024 80936100          sts 97,R24
 0028                   .dbline 22
 0028           ;  delay_nus(65); //PA4设为输入
 0028 01E4              ldi R16,65
 002A 10E0              ldi R17,0
 002C 0E940000          xcall _delay_nus
 0030                   .dbline 24
 0030           ;  
 0030           ;  status=RD_DQ_VAL(); //读总线，为0时器件在线
 0030 40B1              in R20,0x0
 0032 4470              andi R20,4
 0034                   .dbline 25
 0034           ;  delay_nus(500);
 0034 04EF              ldi R16,500
 0036 11E0              ldi R17,1
 0038 0E940000          xcall _delay_nus
 003C                   .dbline 26
 003C           ;  DQ_1();        //释放总线
 003C 80916200          lds R24,98
 0040 8460              ori R24,4
 0042 80936200          sts 98,R24
 0046                   .dbline 27
 0046           ;  return status;
 0046 042F              mov R16,R20
 0048                   .dbline -2
 0048           L2:
 0048                   .dbline 0 ; func end
 0048 4991              ld R20,y+
 004A 0895              ret
 004C                   .dbsym r status 20 c
 004C                   .dbend
 004C                   .dbfunc e readonebyte _readonebyte fc
 004C           ;            dat -> R10
 004C           ;              i -> R20
                        .even
 004C           _readonebyte::
 004C AA92              st -y,R10
 004E 4A93              st -y,R20
 0050                   .dbline -1
 0050                   .dbline 32
 0050           ;  
 0050           ; }
 0050           ; 
 0050           ; unsigned char readonebyte(void) //读一字节
 0050           ; {
 0050                   .dbline 33
 0050           ;   unsigned char i=0,dat=0;
 0050                   .dbline 33
 0050 AA24              clr R10
 0052                   .dbline 34
 0052           ;    for(i=0;i<8;i++)
 0052 4427              clr R20
 0054 1FC0              xjmp L7
 0056           L4:
 0056                   .dbline 35
 0056           ;    {  
 0056                   .dbline 37
 0056           ;      
 0056           ;       DQ_DDR_1();
 0056 80916100          lds R24,97
 005A 8460              ori R24,4
 005C 80936100          sts 97,R24
 0060                   .dbline 38
 0060           ;       DQ_0();      //拉低总线
 0060 80916200          lds R24,98
 0064 8B7F              andi R24,251
 0066 80936200          sts 98,R24
 006A                   .dbline 39
 006A           ;         delay_nus(2);
 006A 02E0              ldi R16,2
 006C 10E0              ldi R17,0
 006E 0E940000          xcall _delay_nus
 0072                   .dbline 40
 0072           ;       DQ_DDR_0();  //读PA4引脚
 0072 80916100          lds R24,97
 0076 8B7F              andi R24,251
 0078 80936100          sts 97,R24
 007C                   .dbline 41
 007C           ;         if(RD_DQ_VAL())
 007C 029B              sbis 0x0,2
 007E 05C0              rjmp L8
 0080           X0:
 0080                   .dbline 42
 0080           ;         dat|=(1<<i); //数据存放在dat中
 0080 01E0              ldi R16,1
 0082 142F              mov R17,R20
 0084 0E940000          xcall lsl8
 0088 A02A              or R10,R16
 008A           L8:
 008A                   .dbline 43
 008A           ;         delay_nus(80);
 008A 00E5              ldi R16,80
 008C 10E0              ldi R17,0
 008E 0E940000          xcall _delay_nus
 0092                   .dbline 44
 0092           ;    }
 0092           L5:
 0092                   .dbline 34
 0092 4395              inc R20
 0094           L7:
 0094                   .dbline 34
 0094 4830              cpi R20,8
 0096 F8F2              brlo L4
 0098           X1:
 0098                   .dbline 45
 0098           ;    return dat;
 0098 0A2D              mov R16,R10
 009A                   .dbline -2
 009A           L3:
 009A                   .dbline 0 ; func end
 009A 4991              ld R20,y+
 009C A990              ld R10,y+
 009E 0895              ret
 00A0                   .dbsym r dat 10 c
 00A0                   .dbsym r i 20 c
 00A0                   .dbend
 00A0                   .dbfunc e writeonebyte _writeonebyte fV
 00A0           ;              i -> R20
 00A0           ;            dat -> R10
                        .even
 00A0           _writeonebyte::
 00A0 AA92              st -y,R10
 00A2 4A93              st -y,R20
 00A4 A02E              mov R10,R16
 00A6                   .dbline -1
 00A6                   .dbline 51
 00A6           ; }
 00A6           ; 
 00A6           ; 
 00A6           ; 
 00A6           ; void writeonebyte(unsigned char dat) //写一字节
 00A6           ; {
 00A6                   .dbline 52
 00A6           ;    unsigned char i=0x01;
 00A6                   .dbline 53
 00A6           ;    for(i=0x01;i!=0x00;i<<=1)
 00A6 41E0              ldi R20,1
 00A8 22C0              xjmp L14
 00AA           L11:
 00AA                   .dbline 54
 00AA           ;    {
 00AA                   .dbline 55
 00AA           ;       DQ_DDR_1();
 00AA 80916100          lds R24,97
 00AE 8460              ori R24,4
 00B0 80936100          sts 97,R24
 00B4                   .dbline 56
 00B4           ;       DQ_0();      //拉低,占总线
 00B4 80916200          lds R24,98
 00B8 8B7F              andi R24,251
 00BA 80936200          sts 98,R24
 00BE                   .dbline 57
 00BE           ;         if(dat&i)
 00BE 2A2C              mov R2,R10
 00C0 2422              and R2,R20
 00C2 31F0              breq L15
 00C4           X2:
 00C4                   .dbline 58
 00C4           ;           DQ_1(); 
 00C4 80916200          lds R24,98
 00C8 8460              ori R24,4
 00CA 80936200          sts 98,R24
 00CE 05C0              xjmp L16
 00D0           L15:
 00D0                   .dbline 60
 00D0           ;         else
 00D0           ;           DQ_0(); 
 00D0 80916200          lds R24,98
 00D4 8B7F              andi R24,251
 00D6 80936200          sts 98,R24
 00DA           L16:
 00DA                   .dbline 61
 00DA           ;         delay_nus(80);
 00DA 00E5              ldi R16,80
 00DC 10E0              ldi R17,0
 00DE 0E940000          xcall _delay_nus
 00E2                   .dbline 62
 00E2           ;         DQ_1(); 
 00E2 80916200          lds R24,98
 00E6 8460              ori R24,4
 00E8 80936200          sts 98,R24
 00EC                   .dbline 63
 00EC           ;    }
 00EC           L12:
 00EC                   .dbline 53
 00EC 440F              lsl R20
 00EE           L14:
 00EE                   .dbline 53
 00EE 4423              tst R20
 00F0 E1F6              brne L11
 00F2           X3:
 00F2                   .dbline -2
 00F2           L10:
 00F2                   .dbline 0 ; func end
 00F2 4991              ld R20,y+
 00F4 A990              ld R10,y+
 00F6 0895              ret
 00F8                   .dbsym r i 20 c
 00F8                   .dbsym r dat 10 c
 00F8                   .dbend
 00F8                   .dbfunc e read_temperature _read_temperature fc
 00F8           ;           temp -> R10
                        .even
 00F8           _read_temperature::
 00F8 AA92              st -y,R10
 00FA                   .dbline -1
 00FA                   .dbline 68
 00FA           ; }
 00FA           ; 
 00FA           ; 
 00FA           ; unsigned char read_temperature(void)
 00FA           ; {
 00FA                   .dbline 70
 00FA           ;   unsigned char temp;
 00FA           ;   if(init_ds18b20()!=0x00)
 00FA 82DF              xcall _init_ds18b20
 00FC 0023              tst R16
 00FE 21F0              breq L18
 0100           X4:
 0100                   .dbline 71
 0100           ;      ds18b20_error=1;            //DS18B20发生故障
 0100 81E0              ldi R24,1
 0102 80932000          sts _ds18b20_error,R24
 0106 13C0              xjmp L19
 0108           L18:
 0108                   .dbline 73
 0108           ;  else
 0108           ;  {
 0108                   .dbline 75
 0108           ; 
 0108           ;    writeonebyte(0xCC);           //跳过序列号匹配
 0108 0CEC              ldi R16,204
 010A CADF              xcall _writeonebyte
 010C                   .dbline 76
 010C           ;    writeonebyte(0x44);           //启动测温
 010C 04E4              ldi R16,68
 010E C8DF              xcall _writeonebyte
 0110                   .dbline 77
 0110           ;    init_ds18b20();
 0110 77DF              xcall _init_ds18b20
 0112                   .dbline 78
 0112           ;    writeonebyte(0xCC);
 0112 0CEC              ldi R16,204
 0114 C5DF              xcall _writeonebyte
 0116                   .dbline 79
 0116           ;    writeonebyte(0xBE);           //读取温度寄存器
 0116 0EEB              ldi R16,190
 0118 C3DF              xcall _writeonebyte
 011A                   .dbline 80
 011A           ;    temp_value[0]=readonebyte();  //温度低8位
 011A 98DF              xcall _readonebyte
 011C 00932100          sts _temp_value,R16
 0120                   .dbline 81
 0120           ;    temp_value[1]=readonebyte();  //温度高8位
 0120 95DF              xcall _readonebyte
 0122 A02E              mov R10,R16
 0124 A0922200          sts _temp_value+1,R10
 0128                   .dbline 82
 0128           ;    ds18b20_error=0;
 0128 2224              clr R2
 012A 20922000          sts _ds18b20_error,R2
 012E                   .dbline 84
 012E           ;    
 012E           ;  }
 012E           L19:
 012E                   .dbline 85
 012E           ;  temp=temp_value[1];
 012E A0902200          lds R10,_temp_value+1
 0132                   .dbline 86
 0132           ;  return temp;
 0132 0A2D              mov R16,R10
 0134                   .dbline -2
 0134           L17:
 0134                   .dbline 0 ; func end
 0134 A990              ld R10,y+
 0136 0895              ret
 0138                   .dbsym r temp 10 c
 0138                   .dbend
 0138                   .dbfunc e convert_temp_data _convert_temp_data fV
 0138           ;             ng -> R20
                        .even
 0138           _convert_temp_data::
 0138 4A93              st -y,R20
 013A                   .dbline -1
 013A                   .dbline 91
 013A           ; }
 013A           ; 
 013A           ; //温度转换
 013A           ; void convert_temp_data(void)
 013A           ; {
 013A                   .dbline 92
 013A           ;    unsigned char ng=0;
 013A 4427              clr R20
 013C                   .dbline 94
 013C           ;           
 013C           ;   if((temp_value[1]&0xF8)==0xF8) //判断温度的正负
 013C 80912200          lds R24,_temp_value+1
 0140 887F              andi R24,248
 0142 883F              cpi R24,248
 0144 91F4              brne L23
 0146           X5:
 0146                   .dbline 95
 0146           ;   {
 0146                   .dbline 96
 0146           ;     temp_value[1]=~temp_value[1];
 0146 20902200          lds R2,_temp_value+1
 014A 2094              com R2
 014C 20922200          sts _temp_value+1,R2
 0150                   .dbline 97
 0150           ;       temp_value[0]=~temp_value[0]+1;
 0150 80912100          lds R24,_temp_value
 0154 8095              com R24
 0156 8F5F              subi R24,255    ; addi 1
 0158 80932100          sts _temp_value,R24
 015C                   .dbline 98
 015C           ;       if(temp_value[0]==0x00) temp_value[1]++;
 015C 8823              tst R24
 015E 21F4              brne L28
 0160           X6:
 0160                   .dbline 98
 0160 822D              mov R24,R2
 0162 8F5F              subi R24,255    ; addi 1
 0164 80932200          sts _temp_value+1,R24
 0168           L28:
 0168                   .dbline 99
 0168           ;       ng=1;                        //负数标志
 0168 41E0              ldi R20,1
 016A                   .dbline 100
 016A           ;   }
 016A           L23:
 016A                   .dbline 102
 016A           ;   
 016A           ;   display_digit[0]=df_table[temp_value[0]&0x0F];    //温度小数部分
 016A 80E0              ldi R24,<_df_table
 016C 90E0              ldi R25,>_df_table
 016E E0912100          lds R30,_temp_value
 0172 FF27              clr R31
 0174 EF70              andi R30,15
 0176 F070              andi R31,0
 0178 E80F              add R30,R24
 017A F91F              adc R31,R25
 017C 2080              ldd R2,z+0
 017E 20922300          sts _display_digit,R2
 0182                   .dbline 103
 0182           ;   currentT=(temp_value[0]>>4)|(temp_value[1]<<4); //温度数值
 0182 80912200          lds R24,_temp_value+1
 0186 8F70              andi R24,#0x0F
 0188 8295              swap R24
 018A 90912100          lds R25,_temp_value
 018E 9295              swap R25
 0190 9F70              andi R25,#0x0F
 0192 982B              or R25,R24
 0194 90930F00          sts _currentT,R25
 0198                   .dbline 105
 0198           ;   
 0198           ;   display_digit[3]=currentT/100;                    //温度百位
 0198 14E6              ldi R17,100
 019A 092F              mov R16,R25
 019C 0E940000          xcall div8u
 01A0 00932600          sts _display_digit+3,R16
 01A4                   .dbline 106
 01A4           ;   display_digit[2]=currentT%100/10;                 //温度十位
 01A4 14E6              ldi R17,100
 01A6 00910F00          lds R16,_currentT
 01AA 0E940000          xcall mod8u
 01AE 1AE0              ldi R17,10
 01B0 0E940000          xcall div8u
 01B4 00932500          sts _display_digit+2,R16
 01B8                   .dbline 107
 01B8           ;   display_digit[1]=currentT%10;                     //温度个位
 01B8 1AE0              ldi R17,10
 01BA 00910F00          lds R16,_currentT
 01BE 0E940000          xcall mod8u
 01C2 00932400          sts _display_digit+1,R16
 01C6                   .dbline 110
 01C6           ;   
 01C6           ;   //温度显示预操作
 01C6           ;   current_temp_display_buffer[11]=display_digit[0]+'0';
 01C6 80912300          lds R24,_display_digit
 01CA 805D              subi R24,208    ; addi 48
 01CC 80930B00          sts _current_temp_display_buffer+11,R24
 01D0                   .dbline 111
 01D0           ;   current_temp_display_buffer[10]='.';
 01D0 8EE2              ldi R24,46
 01D2 80930A00          sts _current_temp_display_buffer+10,R24
 01D6                   .dbline 112
 01D6           ;   current_temp_display_buffer[9]=display_digit[1]+'0';
 01D6 802F              mov R24,R16
 01D8 805D              subi R24,208    ; addi 48
 01DA 80930900          sts _current_temp_display_buffer+9,R24
 01DE                   .dbline 113
 01DE           ;   current_temp_display_buffer[8]=display_digit[2]+'0';
 01DE 80912500          lds R24,_display_digit+2
 01E2 805D              subi R24,208    ; addi 48
 01E4 80930800          sts _current_temp_display_buffer+8,R24
 01E8                   .dbline 114
 01E8           ;   if(display_digit[3]!=0)
 01E8 20902600          lds R2,_display_digit+3
 01EC 2220              tst R2
 01EE 29F0              breq L41
 01F0           X7:
 01F0                   .dbline 115
 01F0           ;   current_temp_display_buffer[7]=display_digit[3]+'0';
 01F0 822D              mov R24,R2
 01F2 805D              subi R24,208    ; addi 48
 01F4 80930700          sts _current_temp_display_buffer+7,R24
 01F8 03C0              xjmp L42
 01FA           L41:
 01FA                   .dbline 117
 01FA           ;   else
 01FA           ;   current_temp_display_buffer[7]=' ';
 01FA 80E2              ldi R24,32
 01FC 80930700          sts _current_temp_display_buffer+7,R24
 0200           L42:
 0200                   .dbline 118
 0200           ;   if(display_digit[2]==0 && display_digit[1]==0)
 0200 20902500          lds R2,_display_digit+2
 0204 2220              tst R2
 0206 39F4              brne L47
 0208           X8:
 0208 20902400          lds R2,_display_digit+1
 020C 2220              tst R2
 020E 19F4              brne L47
 0210           X9:
 0210                   .dbline 119
 0210           ;   current_temp_display_buffer[8]=' ';
 0210 80E2              ldi R24,32
 0212 80930800          sts _current_temp_display_buffer+8,R24
 0216           L47:
 0216                   .dbline 120
 0216           ;   if(ng)                                       //温度为负
 0216 4423              tst R20
 0218 99F0              breq L52
 021A           X10:
 021A                   .dbline 121
 021A           ;   {
 021A                   .dbline 122
 021A           ;     if(current_temp_display_buffer[8]==' ')
 021A 80910800          lds R24,_current_temp_display_buffer+8
 021E 8032              cpi R24,32
 0220 21F4              brne L54
 0222           X11:
 0222                   .dbline 123
 0222           ;          current_temp_display_buffer[8]='-';
 0222 8DE2              ldi R24,45
 0224 80930800          sts _current_temp_display_buffer+8,R24
 0228 0BC0              xjmp L55
 022A           L54:
 022A                   .dbline 125
 022A           ;       else  
 022A           ;     if(current_temp_display_buffer[7]==' ')
 022A 80910700          lds R24,_current_temp_display_buffer+7
 022E 8032              cpi R24,32
 0230 21F4              brne L58
 0232           X12:
 0232                   .dbline 126
 0232           ;          current_temp_display_buffer[7]='-';
 0232 8DE2              ldi R24,45
 0234 80930700          sts _current_temp_display_buffer+7,R24
 0238 03C0              xjmp L59
 023A           L58:
 023A                   .dbline 128
 023A           ;       else  
 023A           ;          current_temp_display_buffer[6]='-';
 023A 8DE2              ldi R24,45
 023C 80930600          sts _current_temp_display_buffer+6,R24
 0240           L59:
 0240           L55:
 0240                   .dbline 129
 0240           ;   }
 0240           L52:
 0240                   .dbline -2
 0240           L22:
 0240                   .dbline 0 ; func end
 0240 4991              ld R20,y+
 0242 0895              ret
 0244                   .dbsym r ng 20 c
 0244                   .dbend
 0244           ; }
 0244           ; 
 0244           ; 
